<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Corvallis Reuse and Repair App</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="javascript/server-proxy.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
</head>
<body class="container">

<h4>Organizations</h4>
<ul id="organizationsList" class="list-group"></ul>
<button id="addOrganizationButton" class="btn btn-standard" data-toggle="modal" data-target="#addOrganizationModal">
    Add Organization
</button>
<div id="addOrganizationModalTarget"></div>
<div id="editOrganizationModalTarget"></div>
<script type="text/javascript">

    $(document).ready(function() {
        /**
         * show the modal and populate the form with existing values
         */
        $("#organizationsList").on('click', 'li', function() {
            console.debug("click detected for organizations list element ", this.value);

            var curOrganizationId = this.value;
            var curOrganization = ($.grep(organizations, function(e) {
                return e.id == curOrganizationId;
            }))[0];

            $("#editOrganizationId").val(curOrganizationId);
            $("#editOrganizationName").val(curOrganization.name);
            $("#editOrganizationPhoneNumber").val(curOrganization.phoneNumber);
            $("#editOrganizationWebsiteUrl").val(curOrganization.websiteUrl);
            $("#editOrganizationPhysicalAddress").val(curOrganization.physicalAddress);

            $("#editOrganizationModal").modal('show');
        });
    });

    function syncOrganizations() {
        serverProxy.getOrganizations(
            function(data, status) {
                console.debug("AJAX success for syncOrganizations", data, status);
                organizations = data;
                populateOrganizationsList();
            },
            function(jqXHR, textStatus, errorThrown) {
                console.log("Error syncing organizations", textStatus, errorThrown);
            }
        );
    }

    function populateOrganizationsList() {
        $("#organizationsList").empty();
        organizations.forEach(function(organization) {
            var listItem = $(document.createElement('li'));
            listItem.addClass("list-group-item");
            listItem.attr("value", organization['id']);
            listItem.html(organization['name']);
            $("#organizationsList").append(listItem);
        });
    }

    /**
     * @citation http://stackoverflow.com/questions/18908531/true-client-side-html-includes
     */
    $(function(){
        $("#addOrganizationModalTarget").load("partials/addOrganizationModal.html", function(){
            $(this).contents().unwrap();
        });
    });

    /**
     * @citation http://stackoverflow.com/questions/18908531/true-client-side-html-includes
     */
    $(function(){
        $("#editOrganizationModalTarget").load("partials/editOrganizationModal.html", function(){
            $(this).contents().unwrap();
        });
    });
</script>

<h4>Categories</h4>
<ul id="categoriesList" class="list-group"></ul>
<button id="addCategoryButton" class="btn btn-standard" data-toggle="modal" data-target="#addCategoryModal">
    Add Category
</button>
<div id="addCategoryModalTarget"></div>
<div id="editCategoryModalTarget"></div>
<script type="text/javascript">

    $(document).ready(function() {
        /**
         * show the modal and populate the form with existing values
         */
        $("#categoriesList").on('click', 'li', function() {

            console.debug("click detected for categories list element ", this.value);

            var curCategoryId = this.value;
            var curCategory = $.grep(categories, function(category) {
                return category.id == curCategoryId;
            })[0];

            $("#editCategoryId").val(curCategoryId);
            $("#editCategoryName").val(curCategory.name);

            $("#editCategoryModal").modal('show');
        });
    });

    function syncCategories() {
        serverProxy.getCategories(
            function (data, status) {
                console.debug("AJAX success for syncCategories", data, status);
                categories = data;
                populateCategoriesList();
            },
            function(jqXHR, textStatus, errorThrown) {
                console.log("Error syncing categories", textStatus, errorThrown);
            }
        );
    }

    function populateCategoriesList() {
        $("#categoriesList").empty();
        //$("#addItemSelectCategory").empty();
        //$("#editItemSelectCategory").empty();
        categories.forEach(function(category) {
            var listItem = $(document.createElement('li'));
            listItem.addClass("list-group-item");
            listItem.attr("value", category['id']);
            listItem.html(category['name']);
            $("#categoriesList").append(listItem);

            /*
            Testing out putting this in the form code

            // Populate the form field in addItem for select category
            var categoryOption = $(document.createElement('option'));
            categoryOption.attr("value", category['id']);
            categoryOption.html(category['name']);
            $("#addItemSelectCategory").append(categoryOption);

            // Populate the form field in editItem for select category
            var categoryOption = $(document.createElement('option'));
            categoryOption.attr("value", category['id']);
            categoryOption.html(category['name']);
            $("#editItemSelectCategory").append(categoryOption);
            */
        });
    }

    /**
     * @citation http://stackoverflow.com/questions/18908531/true-client-side-html-includes
     */
    $(function(){
        $("#addCategoryModalTarget").load("partials/addCategoryModal.html", function(){
            $(this).contents().unwrap();
        });
    });

    /**
     * @citation http://stackoverflow.com/questions/18908531/true-client-side-html-includes
     */
    $(function(){
        $("#editCategoryModalTarget").load("partials/editCategoryModal.html", function(){
            $(this).contents().unwrap();
        });
    });
</script>

<h4>Items</h4>
<ul id="itemsList" class="list-group"></ul>
<button id="addItemButton" class="btn btn-standard" data-toggle="modal" data-target="#addItemModal">
    Add Item
</button>
<div id="addItemModalTarget"></div>
<div id="editItemModalTarget"></div>
<script type="text/javascript">

    $(document).ready(function() {
        /**
         * show the modal and populate the form with existing values
         */
        $("#itemsList").on('click', 'li', function() {

            console.log("click detected for items list element ", this.value);

            var curItemId = this.value;
            var curItem = ($.grep(items, function(e) {
                return e.id == curItemId;
            }))[0];

            $("#editItemId").val(curItemId);
            $("#editItemName").val(curItem.name);

            $("#editItemModal").modal('show');
        });
    });
/*
    function syncItems() {
        serverProxy.getItems(
                function(data, status) {
                    console.debug("AJAX success for syncItems", data, status);
                    items = data;
                    populateItemsList();
                },
                function(jqXHR, textStatus, errorThrown) {
                    console.log("Error syncing database", textStatus, errorThrown);
                }
        );
    }
*/
    function populateItemsList() {

        // Alphabetize by name
        items.sort(function(lhs, rhs) {
            var nameL = lhs['name'].toUpperCase();
            var nameR = rhs['name'].toUpperCase();

            if (nameL < nameR) {
                return -1;
            }
            else if (nameL > nameR) {
                return 1;
            }
            else {
                return 0;
            }
        });

        // Append each item to the list
        var curCategoryRef = null;
        $("#itemsList").empty();
        items.forEach(function(item) {
            var listItem = $(document.createElement('li'));
            listItem.addClass("list-group-item");
            listItem.attr("value", item['id']);
            listItem.html(item['name']);
            $("#itemsList").append(listItem);
        });
    }

    /**
     * @citation http://stackoverflow.com/questions/18908531/true-client-side-html-includes
     */
    $(function(){
        $("#addItemModalTarget").load("partials/addItemModal.html", function(){
            $(this).contents().unwrap();
        });
    });

    /**
     * @citation http://stackoverflow.com/questions/18908531/true-client-side-html-includes
     */
    $(function(){
        $("#editItemModalTarget").load("partials/editItemModal.html", function(){
            $(this).contents().unwrap();
        });
    });
</script>

<script type="text/javascript">

    var serverProxy = new ServerProxy();

    var organizations = null;
    var categories = null;
    var items = null;
    var itemCategories = null;
    var organizationItems = null;

    function syncDatabase() {
        serverProxy.syncDatabase(
            function (data, status) {
                console.debug("AJAX success for syncDatabase", data, status);
                organizations = data['organizations'];
                categories = data['categories'];
                items = data['items'];
                itemCategories = data['itemCategories'];
                organizationItems = data['organizationItems'];

                populateOrganizationsList();
                populateCategoriesList();
                populateItemsList();
            },
            function (jqXHR, textStatus, errorThrown) {
                console.log("Error syncing database", textStatus, errorThrown);
            }
        );
    }

    $(document).ready(function() {
        syncDatabase(); // when the page first loads, sync the database
    });
</script>

</body>
</html>