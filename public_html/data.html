<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Corvallis Reuse and Repair App</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="javascript/server-proxy.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
</head>
<body class="container">

<h4>Organizations</h4>
<ul id="organizationsList" class="list-group"></ul>
<button id="addOrganizationButton" class="btn btn-standard" data-toggle="modal" data-target="#addOrganizationModal">
    Add Organization
</button>
<div id="addOrganizationModalTarget"></div>
<script type="text/javascript">
    /**
     * @citation http://stackoverflow.com/questions/18908531/true-client-side-html-includes
     */
    $(function(){
        $("#addOrganizationModalTarget").load("partials/addOrganizationModal.html", function(){
            $(this).contents().unwrap();
        });
    });
</script>

<h4>Categories</h4>
<ul id="categoriesList" class="list-group"></ul>
<button id="addCategoryButton" class="btn btn-standard" data-toggle="modal" data-target="#addCategoryModal">
    Add Category
</button>
<div id="addCategoryModalTarget"></div>
<script type="text/javascript">
    /**
     * @citation http://stackoverflow.com/questions/18908531/true-client-side-html-includes
     */
    $(function(){
        $("#addCategoryModalTarget").load("partials/addCategoryModal.html", function(){
            $(this).contents().unwrap();
        });
    });
</script>

<div id="updateCategoryModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Edit Category</h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="updateCategoryName">Category name</label>
                    <input class="form-control" type="text" id="updateCategoryName">
                </div>
                <div class="form-group">
                    <button id="updateCategorySubmitButton" class="btn btn-primary" type="button" data-dismiss="modal">
                        Add Category
                    </button>
                    <button class="btn btn-standard pull-right" type="button" data-dismiss="modal">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<h4>Items</h4>
<ul id="itemsList" class="list-group"></ul>
<button id="addItemButton" class="btn btn-standard" data-toggle="modal" data-target="#addItemModal">
    Add Item
</button>
<div id="addItemModalTarget"></div>
<script type="text/javascript">
    /**
     * @citation http://stackoverflow.com/questions/18908531/true-client-side-html-includes
     */
    $(function(){
        $("#addItemModalTarget").load("partials/addItemModal.html", function(){
            $(this).contents().unwrap();
        });
    });</script>

<script type="text/javascript">

    var serverProxy = new ServerProxy();

    var organizations = null;
    var categories = null;
    var items = null;
    var organizationItems = null;

    function syncDatabase() {
        serverProxy.syncDatabase(
                function (data, status) {
                    console.debug("AJAX success for syncDatabase", data, status);
                    organizations = data['organizations'];
                    categories = data['categories'];
                    items = data['items'];
                    organizationItems = data['organizationItems'];

                    populateOrganizationsList();
                    populateCategoriesList();
                    populateItemsList();
                },
                function (jqXHR, textStatus, errorThrown) {
                    console.log("Error syncing database", textStatus, errorThrown);
                });
    }

    function populateOrganizationsList() {
        organizations.forEach(function(organization) {
            var listItem = $(document.createElement('li'));
            listItem.addClass("list-group-item");
            listItem.html(organization['name']);
            $("#organizationsList").append(listItem);
        });
    }

    function populateCategoriesList() {
        categories.forEach(function(category) {
            var listItem = $(document.createElement('li'));
            listItem.addClass("list-group-item");
            listItem.html(category['name']);
            $("#categoriesList").append(listItem);

            // Populate the form field in addItem for select category
            var categoryOption = $(document.createElement('option'));
            categoryOption.attr("value", category['id']);
            categoryOption.html(category['name']);
            $("#addItemSelectCategory").append(categoryOption);
        });
    }

    function populateItemsList() {

        items.sort(function(lhs, rhs) {
            return lhs.categoryRef - rhs.categoryRef;
        })

        var curCategoryRef = null;
        items.forEach(function(item) {

            if (curCategoryRef == null || item.categoryRef != curCategoryRef) {
                curCategoryRef = item.categoryRef;
                var listItemGroup = $(document.createElement('li'));
                listItemGroup.addClass("list-group-item");

                var category = ($.grep(categories, function(e) {
                    return e.id == item['categoryRef'];
                }))[0];

                var categoryName = category['name'];

                listItemGroup.html("<h4>" + categoryName + "</h4>");
                $("#itemsList").append(listItemGroup);
            }

            var listItem = $(document.createElement('li'));
            listItem.addClass("list-group-item");
            listItem.html(item['name']);
            $("#itemsList").append(listItem);
        });
    }

    $(document).ready(function() {
        syncDatabase(); // when the page first loads, sync the database
    });
</script>

</body>
</html>